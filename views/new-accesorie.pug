extends ./admin-layout.pug
block contenido
  main.main-admin
    button.btn.btn-go-back(onclick = "window.history.back()") 
      img(src="/public/img/admin/atras.png" alt="")
      | Atras 
    h3.main-title Nuevo Accesorio
    label.btn.btn-add-photo(for="file-selector")
      img(src="/public/img/admin/camera.png" alt="") 
      | Seleccionar Foto
    section.gallery-section
      article.gallery
        span(style = 'font-weight: 600;color: #4c4c4c;') No ha seleccionado ninguna foto
      .gallery-move 
        button.btn.btn-prev(type="submit")
          img(src="/public/img/admin/atras.png" alt="") 
        button.btn.btn-next(type="submit")
          img(src="/public/img/admin/adelante.png" alt="")
    article.form-container
      form(id="create-article" action="/admin/accesorios/" method='POST' class="form-group" enctype="multipart/form-data")

        input(type="text" class="form-input" name="type" placeholder="Tipo de accesorio" required)

        input(type="text" class="form-input" name="price" placeholder="Precio" required)

        input(type="text" class="form-input" name="description" placeholder="Descripción")

        input(type="text" class="form-input" name="cnt" placeholder="Cantidad de articulos")

        input(type="text" class="form-input" name="ownerName" placeholder="Nombre del dueño" required)

        input(type="text" class="form-input" name="ownerPhone" placeholder="Télefono" required)

        input(type="text" class="form-input" name="ownerAccount" placeholder="Cuenta bancaria")

        input.form-input(type="file" id="file-selector" multiple  name="images" accept="image/*" )

        .btn-save-container
          input(type="submit" class="btn btn-save " value="Guardar")
          a.btn.btn-cancel(href="/admin/accesorios") Cancelar
  script.
   const inputFile = document.querySelector("#file-selector"),
     formCreateArticle = document.querySelector("#create-article"),
     inputsData = document.querySelectorAll(".form-input"),
     btnAddPhoto = document.querySelector("btn-add-photo"),
     filesSelected = document.querySelector(".file-selected"),
     gallery = document.querySelector(".gallery"),
     btnPrevImage = document.querySelector(".btn-prev"),
     btnNextImage = document.querySelector(".btn-next");

    function handleForm(){
        const formData = new FormData();
        for(let img of inputFile.files){
          formData.append("images",img);
        }
        inputsData.forEach((el)=>{
            if(el.name != "images")
            {
              formData.append(el.name, el.value);
            }
        });
        const url = `/admin/accesorios/`;
        fetch(url,{
          method: "POST",
          body: formData,
        }).then(result => {
            if(result.ok)
              window.location.reload();
          })
    } 

    formCreateArticle.addEventListener("submit", (e)=>{
        e.preventDefault();
        if(gallery.firstElementChild.tagName !== "SPAN")
          handleForm();
    });

    //Galeria de imagenes
    let idxGallery = 0;
    function moveGallery(dir) {
        if (!dir) {
            let flag = 0;
            for (idxGallery; idxGallery >= -1; idxGallery--) {
                let node = gallery.children[idxGallery];
                if (flag) {
                    if (idxGallery === -1) {
                        node = gallery.children[gallery.childElementCount - 1];
                        idxGallery = gallery.childElementCount - 1;
                    }
                    node.classList.add("picture-show");
                    flag = 0;
                    break;
                }
                if (node.classList.contains("picture-show")) {
                    node.classList.remove("picture-show");
                    flag = 1;
                }
            }
        } else {
            let flag = 0;
            for (idxGallery; idxGallery <= gallery.children.length; idxGallery++) {
                let node = gallery.children[idxGallery];
                if (flag) {
                    if (idxGallery === gallery.children.length) {
                        node = gallery.children[0];
                        idxGallery = 0;
                    }
                    node.classList.add("picture-show");
                    flag = 0;
                    break;
                }
                if (node.classList.contains("picture-show")) {
                    node.classList.remove("picture-show");
                    flag = 1;
                }
            }
        }
    }
      
    function handleDelete(node){
        node.lastElementChild.addEventListener("click", function () {
        //Mover al siguiente
        for (let p = 0; p < gallery.children.length; p++) {
            let n = gallery.children[p];
            if (n.classList.contains("picture-show")) {
                idxGallery = p == gallery.children.length - 1 ? 0 : p;
                break;
            }
        }
        gallery.removeChild(node);

        if (gallery.childElementCount == 0) {
          gallery.innerHTML = "<span style = 'font-weight: 600;color: #4c4c4c;'>No ha seleccionado ninguna foto </span>";
          btnPrevImage.parentElement.style.display = "none";
        }
        gallery.children[idxGallery].classList.add("picture-show");
    });
    } 

    btnPrevImage.addEventListener("click", function () {
      moveGallery(0);
    });
    btnNextImage.addEventListener("click", function () {
      moveGallery(1);
    });

    inputFile.addEventListener("change", function () {
      let currentFiles = inputFile.files;
      if ( currentFiles.length === 0 && gallery.childElementCount === 0) {
        gallery.innerHTML ="<span style = 'font-weight: 600;color: #4c4c4c;'>No ha seleccionado ninguna foto </span>";
      } else {
        if (
          !gallery.childElementCount ||
          (currentFiles.length && !gallery.children[0] != "span")
        ) {
          gallery.innerHTML = "";
        }
        //muestro los botones si hay elementos
        if(currentFiles.length){
          btnPrevImage.parentElement.style.display = "block";
        }
        let flag = 0;
        for (let file of currentFiles) {
          let reader = new FileReader();

          reader.addEventListener("load", function (e) {
            const node = document.createElement("div");
            node.classList.add("picture");
            node.innerHTML = `<img src=${reader.result} alt=''> <button type='submit' class='btn btn-delete btn-delete-photo'><img src='/public/img/res/borrar.png'></button>`;
            if (!flag) {
                node.classList.add("picture-show");
                flag = 1;
            }
            gallery.appendChild(node);
            handleDelete(node);
          });
          reader.readAsDataURL(file);
        }
      }
    });